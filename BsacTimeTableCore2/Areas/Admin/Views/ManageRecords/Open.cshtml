@{
    ViewData["Title"] = "Open";
}
<style>
    .container {
        width: auto;
        padding-right: 1px;
        padding-left: 1px;
    }

    th {
        text-align: center;
    }
</style>
<environment include="Development">
    <link rel="stylesheet" href="~/lib/bootstrap-select/dist/css/bootstrap-select.css" />
</environment>
<environment exclude="Development">
    <link href="~/lib/bootstrap-select/dist/css/bootstrap-select.min.css" rel="stylesheet" />
</environment>
<div id="groupsDiv" hidden="hidden">@ViewBag.groupsJSON</div>
<form asp-action="Open" asp-route-id=@Context.Request.Query["id"] asp-route-date=@Context.Request.Query["date"] method="post">

    <table id="recordsTable" class="table table-bordered" style="margin-top: 2px;">
        @await Html.PartialAsync("_ManageRecordsOpenHeadPartial")
        <tbody>
        </tbody>
    </table>
    <div style="display:inline;">
        <label class="form-check-label" for="defaultCheck2">
            Показать/спрятать 5,6,7 пары:
        </label>
        <input class="form-check-input" type="checkbox" id="defaultCheck2" onclick="changeShow567lessons()" checked>
    </div>
    <div style="display:inline; padding-left:20px" onclick="downloadTTInDocx()"><input value="Скачать в формате .docx" class="btn btn-info" /></div>
    <div style="float: right; padding-right: 20px"><input type="submit" value="Сохранить" class="btn btn-success" /></div>

    <div class="modal fade" id="exampleModalLong" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <label class="form-check-label" for="defaultCheck1">
                        Показать/спрятать подгруппы:
                    </label>
                    <input class="form-check-input" type="checkbox" id="defaultCheck1" onclick="changeModalInputs()">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <table hidden="hidden" id="ModalInputsSubgroups">
                    <tr>
                        <th>
                            1я подгруппа
                        </th>
                        <th>
                            2я подгруппа
                        </th>
                    </tr>
                    <tr>
                        <td>
                            <div class="modal-body" id="ModalInputs1">
                                <div><select id="lecturesSelect1" title="Ничего не выбрано" class="selectpicker" data-live-search="true" asp-items=ViewBag.Lecturers></select><span>Выберите преподавателя</span></div>
                                <div><select id="classroomsSelect1" title="Ничего не выбрано" class="selectpicker" data-live-search="true" asp-items=ViewBag.Classrooms></select><span>Выберите кабинет</span></div>
                                <div><select id="subjectsSelect1" title="Ничего не выбрано" class="selectpicker" data-live-search="true" asp-items=ViewBag.Subjects></select><span>Выберите предмет</span></div>
                                <div><select id="subjectTypesSelect1" title="Ничего не выбрано" class="selectpicker" data-live-search="true" asp-items=ViewBag.SubjectTypes></select><span>Выберите тип занятия</span></div>
                            </div>
                        </td>
                        <td>
                            <div class="modal-body" id="ModalInputs2">
                                <div><select id="lecturesSelect2" title="Ничего не выбрано" class="selectpicker" data-live-search="true" asp-items=ViewBag.Lecturers></select><span>Выберите преподавателя</span></div>
                                <div><select id="classroomsSelect2" title="Ничего не выбрано" class="selectpicker" data-live-search="true" asp-items=ViewBag.Classrooms></select><span>Выберите кабинет</span></div>
                                <div><select id="subjectsSelect2" title="Ничего не выбрано" class="selectpicker" data-live-search="true" asp-items=ViewBag.Subjects></select><span>Выберите предмет</span></div>
                                <div><select id="subjectTypesSelect2" title="Ничего не выбрано" class="selectpicker" data-live-search="true" asp-items=ViewBag.SubjectTypes></select><span>Выберите тип занятия</span></div>
                            </div>
                        </td>
                    </tr>
                </table>
                <div class="modal-body" id="ModalInputs">
                    <div><select id="lecturesSelect3" title="Ничего не выбрано" class="selectpicker" data-live-search="true" asp-items=ViewBag.Lecturers></select><span>Выберите преподавателя</span></div>
                    <div><select id="classroomsSelect3" title="Ничего не выбрано" class="selectpicker" data-live-search="true" asp-items=ViewBag.Classrooms></select><span>Выберите кабинет</span></div>
                    <div><select id="subjectsSelect3" title="Ничего не выбрано" class="selectpicker" data-live-search="true" asp-items=ViewBag.Subjects></select><span>Выберите предмет</span></div>
                    <div><select id="subjectTypesSelect3" title="Ничего не выбрано" class="selectpicker" data-live-search="true" asp-items=ViewBag.SubjectTypes></select><span>Выберите тип занятия</span></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" onclick="deleteAndCloseModal()">Удалить</button>
                    <button type="button" class="btn btn-primary" onclick="saveAndCloseModal()">Сохранить</button>
                </div>
            </div>
        </div>
    </div>
</form>
<br>


@section Scripts{

    <environment include="Development">
        <script src="~/lib/bootstrap-select/dist/js/bootstrap-select.js"></script>
    </environment>
    <environment exclude="Development">
        <script src="~/lib/bootstrap-select/dist/js/bootstrap-select.min.js"></script>
    </environment>

    <script>
        var globalModalObj;

        var groups = JSON.parse($('#groupsDiv').text());
        var groupindex = 0;
        getAndPrintRecords();

        function getAndPrintRecords() {
            if (groups[groupindex] == null)
                return;
            $.ajax({
                url: "GetRecordsByGroupId?id=" + groups[groupindex].Id + "&date=" + "@Context.Request.Query["date"]",
            }).done(
                function (data) {
                    printRecords(JSON.parse(data));
                    groupindex++;
                    getAndPrintRecords();
                });
        }

        function printRecords(data) {
            var stringsObj = getStringsObjFromDataObj(data);
            $("#recordsTable tbody").append(
                "<tr>" +
                "<td rowspan='2'>" + groups[groupindex].Name + "</td>" +
                stringsObj.str1 +
                "</tr>"
            );
            $("#recordsTable tbody").append(
                "<tr>" +
                stringsObj.str2 +
                "</tr>"
            );
        }

        function getStringsObjFromDataObj(data) {
            var str1 = "";
            var str2 = "";
            var c1 = 0;
            var c2 = 0;
            var rowSpan;
            var record1 = data.recordsForAllAndFirstSubgroup[c1];
            var record2 = data.recordsForSecondSubgroup[c2];

            for (var i = 1; i < 6; i++) {
                for (var j = 1; j < 8; j++) {

                    var isPrintedRecordForBothSubgroups = false;
                    var rowSpan = 1;

                    if (record1 != null && record1.SubjOrdinalNumber == j && (new Date(record1.Date)).getDay() == i) {
                        if (record1.SubjectForId == 3) {
                            rowSpan = 2;
                            isPrintedRecordForBothSubgroups = true;
                        }
                        str1 += "<td rowspan='" + rowSpan + "' onclick='showModal(this)'>" +
                            "<div class='LecturerName'>" + record1.Name + "</div>" +
                            "<div class='ClassroomName'>" + record1.ClassroomName + "</div>" +
                            "<div class='SubjectAbname'>" + record1.AbnameSubject + "</div>" +
                            "</td>";
                        record1 = data.recordsForAllAndFirstSubgroup[++c1];
                    }
                    else {
                        str1 += "<td onclick='showModal(this)'></td>";
                    }

                    if (record2 != null && record2.SubjOrdinalNumber == j && (new Date(record2.Date)).getDay() == i) {
                        str2 += "<td onclick='showModal(this)'>" +
                            "<div class='LecturerName'>" + record2.Name + "</div>" +
                            "<div class='ClassroomName'>" + record2.ClassroomName + "</div>" +
                            "<div class='SubjectAbname'>" + record2.AbnameSubject + "</div>" +
                            "</td>";
                        record2 = data.recordsForSecondSubgroup[++c2];
                    }
                    else if (!isPrintedRecordForBothSubgroups){
                        str2 += "<td onclick='showModal(this)'></td>";
                    }
                }
            }

            return { str1, str2 };
        }

        function showModal(domObj) {
            globalModalObj = domObj;
            $("#exampleModalLong").modal();

            $("#lecturesSelect1").val($(domObj).find('.LecturerId1').val());
            $("#classroomsSelect1").val($(domObj).find('.ClassroomId1').val());
            $("#subjectsSelect1").val($(domObj).find('.SubjectId1').val());
            $("#subjectTypesSelect1").val($(domObj).find('.SubjectTypeId1').val());

            $("#lecturesSelect2").val($(domObj).find('.LecturerId2').val());
            $("#classroomsSelect2").val($(domObj).find('.ClassroomId2').val());
            $("#subjectsSelect2").val($(domObj).find('.SubjectId2').val());
            $("#subjectTypesSelect2").val($(domObj).find('.SubjectTypeId2').val());

            $("#lecturesSelect3").val($(domObj).find('.LecturerId3').val());
            $("#classroomsSelect3").val($(domObj).find('.ClassroomId3').val());
            $("#subjectsSelect3").val($(domObj).find('.SubjectId3').val());
            $("#subjectTypesSelect3").val($(domObj).find('.SubjectTypeId3').val());

            if ($(domObj).find('.LecturerId1').val() != null || $(domObj).find('.LecturerId2').val() != null) {
                $('#defaultCheck1').prop("checked", true);
            }
            else {
                $('#defaultCheck1').prop("checked", false);
            }

            changeModalInputs();

            $('.selectpicker').selectpicker('refresh');
        }

        function isPassedCheckInputs(id) {
            var isPass = true;

            $(id + " .selectpicker").each(function () {
                if ($(this).val() == null) {
                    $(this).next().css('background-color', '#d9534f');
                    isPass = false;
                }
            });
            setTimeout(function () {
                $(id + " .selectpicker").next().css('background-color', '');
            }, 100);

            return isPass;
        }

        function saveAndCloseModal() {
            if ($('#defaultCheck1').is(":checked")) {
                var isPassed1 = isPassedCheckInputs("#ModalInputs1");
                var isPassed2 = isPassedCheckInputs("#ModalInputs2");
                if (!isPassed1 && !isPassed2)
                    return;
                if (isPassed1 && isPassed2) {
                    $(globalModalObj).find('.IsChanged1').val(true);
                    $(globalModalObj).find('.IsChanged2').val(true);
                    $(globalModalObj).find('.IsDeleted1').val(null);
                    $(globalModalObj).find('.IsDeleted2').val(null);
                    $(globalModalObj).find('.IsDeleted3').val(true);
                    $(globalModalObj).find('.LecturerName')
                        .text($("#lecturesSelect1 :selected").text() + " " + $("#lecturesSelect2 :selected").text());
                    $(globalModalObj).find('.ClassroomName')
                        .text($("#classroomsSelect1 :selected").text() + " " + $("#classroomsSelect2 :selected").text());
                    $(globalModalObj).find('.SubjectAbname')
                        .text($("#subjectsSelect1 :selected").text() + " " + $("#subjectsSelect2 :selected").text());

                    $(globalModalObj).find('.LecturerId1').val($("#lecturesSelect1").val());
                    $(globalModalObj).find('.ClassroomId1').val($("#classroomsSelect1").val());
                    $(globalModalObj).find('.SubjectId1').val($("#subjectsSelect1").val());
                    $(globalModalObj).find('.SubjectTypeId1').val($("#subjectTypesSelect1").val());

                    $(globalModalObj).find('.LecturerId2').val($("#lecturesSelect2").val());
                    $(globalModalObj).find('.ClassroomId2').val($("#classroomsSelect2").val());
                    $(globalModalObj).find('.SubjectId2').val($("#subjectsSelect2").val());
                    $(globalModalObj).find('.SubjectTypeId2').val($("#subjectTypesSelect2").val());
                }
                else if (isPassed1) {
                    $(globalModalObj).find('.IsChanged1').val(true);
                    $(globalModalObj).find('.IsChanged2').val(null);
                    $(globalModalObj).find('.IsDeleted1').val(null);
                    $(globalModalObj).find('.IsDeleted2').val(true);
                    $(globalModalObj).find('.IsDeleted3').val(true);
                    $(globalModalObj).find('.LecturerName')
                        .text($("#lecturesSelect1 :selected").text());
                    $(globalModalObj).find('.ClassroomName')
                        .text($("#classroomsSelect1 :selected").text());
                    $(globalModalObj).find('.SubjectAbname')
                        .text($("#subjectsSelect1 :selected").text());

                    $(globalModalObj).find('.LecturerId1').val($("#lecturesSelect1").val());
                    $(globalModalObj).find('.ClassroomId1').val($("#classroomsSelect1").val());
                    $(globalModalObj).find('.SubjectId1').val($("#subjectsSelect1").val());
                    $(globalModalObj).find('.SubjectTypeId1').val($("#subjectTypesSelect1").val());
                }
                else if (isPassed2) {
                    $(globalModalObj).find('.IsChanged1').val(null);
                    $(globalModalObj).find('.IsChanged2').val(true);
                    $(globalModalObj).find('.IsDeleted1').val(true);
                    $(globalModalObj).find('.IsDeleted2').val(null);
                    $(globalModalObj).find('.IsDeleted3').val(true);
                    $(globalModalObj).find('.LecturerName')
                        .text($("#lecturesSelect2 :selected").text());
                    $(globalModalObj).find('.ClassroomName')
                        .text($("#classroomsSelect2 :selected").text());
                    $(globalModalObj).find('.SubjectAbname')
                        .text($("#subjectsSelect2 :selected").text());

                    $(globalModalObj).find('.LecturerId2').val($("#lecturesSelect2").val());
                    $(globalModalObj).find('.ClassroomId2').val($("#classroomsSelect2").val());
                    $(globalModalObj).find('.SubjectId2').val($("#subjectsSelect2").val());
                    $(globalModalObj).find('.SubjectTypeId2').val($("#subjectTypesSelect2").val());
                }
            }
            else {
                if (!isPassedCheckInputs("#ModalInputs"))
                    return;

                $(globalModalObj).find('.IsChanged3').val(true);
                $(globalModalObj).find('.IsDeleted1').val(true);
                $(globalModalObj).find('.IsDeleted2').val(true);
                $(globalModalObj).find('.IsDeleted3').val(null);

                $(globalModalObj).find('.LecturerName').text($("#lecturesSelect3 :selected").text());
                $(globalModalObj).find('.ClassroomName').text($("#classroomsSelect3 :selected").text());
                $(globalModalObj).find('.SubjectAbname').text($("#subjectsSelect3 :selected").text());

                $(globalModalObj).find('.LecturerId3').val($("#lecturesSelect3").val());
                $(globalModalObj).find('.ClassroomId3').val($("#classroomsSelect3").val());
                $(globalModalObj).find('.SubjectId3').val($("#subjectsSelect3").val());
                $(globalModalObj).find('.SubjectTypeId3').val($("#subjectTypesSelect3").val());
            }

            $("#exampleModalLong").modal("hide");
        }

        function deleteAndCloseModal() {
            $(globalModalObj).find('.IsChanged1').val(null);
            $(globalModalObj).find('.IsDeleted1').val(true);
            $(globalModalObj).find('.IsChanged2').val(null);
            $(globalModalObj).find('.IsDeleted2').val(true);
            $(globalModalObj).find('.IsChanged3').val(null);
            $(globalModalObj).find('.IsDeleted3').val(true);
            $(globalModalObj).find('.LecturerName').text("");
            $(globalModalObj).find('.ClassroomName').text("");
            $(globalModalObj).find('.SubjectAbname').text("");
            $("#exampleModalLong").modal("hide");
        }

        function changeModalInputs() {
            if ($('#defaultCheck1').is(":checked")) {
                $('#ModalInputsSubgroups').show();
                $('#ModalInputs').hide();
            }
            else {
                $('#ModalInputsSubgroups').hide();
                $('#ModalInputs').show();
            }
        }

        function changeShow567lessons() {
            if ($('#defaultCheck2').is(":checked")) {
                $('.567lesson').show();
                $('.columnDayName').attr('colspan', 7);
            }
            else {
                $('.567lesson').hide();
                $('.columnDayName').attr('colspan', 4);
            }
        }

        function downloadTTInDocx() {
            window.location = "@Url.Action("DownloadTTInDocx")";
        }

    </script>
}
